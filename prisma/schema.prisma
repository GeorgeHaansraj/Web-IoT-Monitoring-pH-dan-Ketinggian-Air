// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  password     String
  role         String        @default("user") // "user" or "admin"
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Relasi untuk tracking pump control
  pumpHistory  PumpHistory[]
}

model PHReading {
  id          String   @id @default(cuid())
  value       Float
  location    String   // "kolam" or "sawah"
  timestamp   DateTime @default(now())
  deviceId    String?
  temperature Float?
  
  @@map("ph_readings")
}

model WaterLevelReading {
  id          String   @id @default(cuid())
  level       Float    // in cm or meters
  location    String   // "kolam" or "sawah"
  timestamp   DateTime @default(now())
  deviceId    String?
  status      String   @default("normal") // "low", "normal", "high", "critical"
  
  @@map("water_level_readings")
}

model Alert {
  id          String   @id @default(cuid())
  type        String   // "ph_high", "ph_low", "water_low", "water_high"
  message     String
  location    String
  severity    String   @default("medium") // "low", "medium", "high", "critical"
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  
  @@map("alerts")
}

model DeviceStatus {
  id         String   @id @default("global-device")
  activeMode String   // "sawah" or "kolam"
  battery    Float?   // Battery percentage
  signal     Int?     // Signal strength
  lastUpdate DateTime @updatedAt
  
  @@map("device_status")
}
model PumpStatus {
  id            String   @id @default(cuid())
  mode          String   @unique // "sawah" or "kolam"
  isOn          Boolean  @default(false)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  
  // NEW: Duration tracking for timed pump control
  pumpDuration  Int?     // Duration in hours (null = manual/indefinite)
  pumpStartTime DateTime? // When pump was turned ON (for calculating auto-OFF)
  isManualMode  Boolean  @default(false) // true = manual (no auto-OFF by duration), false = timed
  
  @@map("pump_status")
}

model DeviceControl {
  id        String   @id @default(cuid())
  deviceId  String?  // "ESP32-KKN-01" atau null untuk global
  mode      String?  // "sawah", "kolam", atau null untuk global
  command   String   @default("OFF")  // "ON", "OFF", "STANDBY"
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  
  // Metadata untuk tracking
  actionBy  String?  // User ID atau "system" atau "esp32"
  reason    String?  // Alasan command dikirim (opsional)
  
  @@map("device_controls")
  @@unique([deviceId, mode]) // Satu command per device+mode combo
  @@index([updatedAt])
}

model PumpHistory {
  id           String   @id @default(cuid())
  mode         String   // "sawah" or "kolam"
  previousState Boolean
  newState     Boolean
  changedBy    String   @default("dashboard") // "dashboard", "esp", "manual"
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])
  timestamp    DateTime @default(now())
  
  @@map("pump_history")
  @@index([mode, timestamp])
  @@index([userId])
}

model MonitoringLog {
  id             String   @id @default(cuid())
  battery_level  Float?   // Battery percentage (0-100)
  ph_value       Float?   // pH value (0-14)
  level          Float?   // Water level in cm
  temperature    Float?   // Temperature from pH sensor (optional, may not exist in old schemas)
  signal_strength Int?    // Signal quality (CSQ)
  created_at     DateTime @default(now())
  deviceId       String?  // Device identifier
  
  @@map("monitoring_logs")
  @@index([created_at])
}