generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  phone         String         @unique // Phone number as unique identifier
  fullName      String         @default("Unknown") // Full name (required)
  password      String
  role          String         @default("user")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  adminMessages AdminMessage[]
  pumpHistory   PumpHistory[]
}

model PHReading {
  id          String   @id @default(cuid())
  value       Float
  location    String
  timestamp   DateTime @default(now())
  deviceId    String?
  temperature Float?

  @@map("ph_readings")
}

model WaterLevelReading {
  id        String   @id @default(cuid())
  level     Float
  timestamp DateTime @default(now())

  @@map("water_level_readings")
}

model Alert {
  id         String    @id @default(cuid())
  type       String
  message    String
  location   String
  severity   String    @default("medium")
  isRead     Boolean   @default(false)
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@map("alerts")
}

model DeviceStatus {
  id         String   @id @default("global-device")
  activeMode String
  battery    Float?
  signal     Int?
  lastUpdate DateTime @updatedAt
  pumpStatus Boolean  @default(false)

  @@map("device_status")
}

model PumpStatus {
  id            String    @id @default(cuid())
  mode          String    @unique
  isOn          Boolean   @default(false)
  updatedAt     DateTime  @updatedAt
  createdAt     DateTime  @default(now())
  isManualMode  Boolean   @default(false)
  pumpDuration  Int?
  pumpStartTime DateTime?

  @@map("pump_status")
}

model DeviceControl {
  id        String   @id @default(cuid())
  deviceId  String?
  mode      String?
  command   String   @default("OFF")
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  actionBy  String?
  reason    String?

  @@unique([deviceId, mode])
  @@index([updatedAt])
  @@map("device_controls")
}

model PumpHistory {
  id            String   @id @default(cuid())
  mode          String
  previousState Boolean
  newState      Boolean
  changedBy     String   @default("dashboard")
  userId        String?
  timestamp     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id])

  @@index([mode, timestamp])
  @@index([userId])
  @@map("pump_history")
}

model MonitoringLog {
  id              String   @id @default(cuid())
  battery_level   Float?
  ph_value        Float?
  level           Float?
  temperature     Float?
  signal_strength Int?
  created_at      DateTime @default(now())
  deviceId        String?
  pump_status     String?  @default("false")

  @@index([created_at])
  @@map("monitoring_logs")
}

model AdminMessage {
  id                  String    @id @default(cuid())
  userId              String
  message             String
  isRead              Boolean   @default(false)
  readAt              DateTime?
  dismissedByUserIds  String[]  @default([]) // Track which users dismissed this message
  createdAt           DateTime  @default(now())
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([isRead])
  @@map("admin_messages")
}

model PumpTimer {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  mode         String    @unique
  duration     Int?
  startTime    DateTime?
  isManualMode Boolean   @default(false)
  updatedAt    DateTime  @default(now()) @updatedAt
  createdAt    DateTime  @default(now())

  @@index([mode], map: "idx_pump_timers_mode")
  @@map("pump_timers")
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String   // e.g. "External Web", "Mobile App"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsed  DateTime?

  @@map("api_keys")
}
